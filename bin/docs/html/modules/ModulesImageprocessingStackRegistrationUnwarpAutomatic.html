---
layout: default
---

<head>
    <link rel="stylesheet" href="../../css/index.css">
</head>

<body>
<!-- Side navigation -->
<div class="sidenav">
    <a href="../../index.html" class="nav1">Introduction</a>
    <a href="../gettingstarted.html" class="nav1">Getting started</a>
    <a href="../modulelist.html" class="nav1">Modules</a>
    <a href="../macrolist.html" class="nav1">Macros</a>
    <!-- <a href="../extendingmia.html" class="nav1">Extending MIA</a> -->
</div>

<!-- Page content -->
<div class="main">
    <!--The following is replaced automatically by the generated module list-->
    <a href="../modulelist.html">Back to module list</a>
<h1>Unwarp (automatic)</h1>
<h2>Description</h2>
Apply slice-by-slice (2D) B-spline unwarping-based image registration to a multi-dimensional stack.  Images can be aligned relative to the first frame in the stack, the previous frame or a separate image in the workspace.  The registration transform can also be calculated from a separate stack to the one that it will be applied to.  Registration can be performed along either the time or Z axes.  The non-registered axis (e.g. time axis when registering in Z) can be "linked" (all frames given the same registration) or "independent" (each stack registered separately).<br><br>This module uses the <a href="https://imagej.net/BUnwarpJ">BUnwarpJ</a> plugin to calculate and apply the necessary 2D transforms.  Detailed information about how the BUnwarpJ process works can be found at <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a>.
<h2>Parameters</h2>
<ul><li><b>Input image</b> (default = "") Image from workspace to apply registration to.</li><br><li><b>Apply to input image</b> (default = "true") When selected, the post-operation image will overwrite the input image in the workspace.  Otherwise, the image will be saved to the workspace with the name specified by the "Output image" parameter.</li><br><li><b>Output image</b> (default = "") If "Apply to input image" is not selected, the post-operation image will be saved to the workspace with this name.</li><br><li><b>Registration axis</b> (default = "Time") Controls which stack axis the registration will be applied in.  For example, when "Time" is selected, all images along the time axis will be aligned.  Choices are: Time, Z.</li><br><li><b>Other axis mode</b> (default = "Independent") For stacks with non-registration axis lengths longer than 1 (e.g. the "Z" axis when registering in time) the behaviour of this other axis is controlled by this parameter:<br><ul><li>"Independent" Each non-registration axis is registered independently.  For example, applying separate Z-registrations for each timepoint of a 4D stack.</li><li>"Linked" All elements of the non-registration axis are registered with a single transform.  For example, applying the same registration at a timepoint to all slices of a 4D stack.</li></ul></li><br><li><b>Fill mode</b> (default = "Black") Controls what intensity any border pixels will have.  "Borders" in this case correspond to strips/wedges at the image edge corresponding to regions outside the initial image (e.g. the right-side of an output image when the input was translated to the left).   Choices are: Black, White.</li><br><li><b>Enable multithreading</b> (default = "true") When selected, certain parts of the registration process will be run on multiple threads of the CPU.  This can provide a speed improvement when working on a computer with a multi-core CPU.</li><br><li><b>Reference mode</b> (default = "First frame") Controls what reference image each image will be compared to:<br><ul><li>"First frame" All images will be compared to the first frame (or slice when in Z-axis mode).  For image sequences which continuously evolve over time (e.g. cells dividing) this can lead to reduced likelihood of successfully calculating the transform over time.</li><li>"Previous N frames" Each image will be compared to the N frames (or slice when in Z-axis mode) immediately before it (number of frames specified by "Number of previous frames").  These reference frames are consolidated into a single reference image using a projection based on the statistic specified by "Previous frames statistic".  This mode copes better with image sequences which continuously evolve over time, but can also lead to compounding errors over time (errors in registration get propagated to all remaining slices).</li><li>"Specific image" All images will be compared to a separate 2D image from the workspace.  The image to compare to is selected using the "Reference image" parameter.</li></ul></li><br><li><b>Number of previous frames</b> (default = "1") Number of previous frames (or slices) to use as reference image when "Reference mode" is set to "Previous N frames".  If there are insufficient previous frames (e.g. towards the beginning of the stack) the maximum available frames will be used.  Irrespective of the number of frames used, the images will be projected into a single reference image using the statistic specified by "Previous frames statistic".</li><br><li><b>Previous frames statistic</b> (default = "Maximum") Statistic to use when combining multiple previous frames as a reference ("Reference mode" set to "Previous N frames").</li><br><li><b>Reference image</b> (default = "") If "Reference mode" is set to "Specific image" mode, all input images will be registered relative to this image.  This image must only have a single channel, slice and timepoint.</li><br><li><b>Calculation source</b> (default = "Internal") Controls whether the input image will be used to calculate the registration transform or whether it will be determined from a separate image:<br><ul><li>"External" The transform is calculated from a separate image from the workspace (specified using "External source").  This could be an image with enhanced contrast (to enable better feature extraction), but where the enhancements are not desired in the output registered image.  When "Other axis mode" is set to "Linked", the external image must be the same length along the registration axis and have single-valued length along the non-registration axis.  However, when set to "Independent", the external image must have the same axis lengths for both the registration and non-registration axes.</li><li>"Internal" The transform is calculated from the input image.</li></ul></li><br><li><b>External source</b> (default = "") If "Calculation source" is set to "External", registration transforms will be calculated using this image from the workspace.  This image will be unaffected by the process.</li><br><li><b>Calculation channel</b> (default = "1") If calculating the registration transform from a multi-channel image stack, the transform will be determined from this channel only.  Irrespectively, for multi-channel image stacks, the calculated transform will be applied equally to all channels.</li><br><li><b>Show detected points</b> (default = "false") When enabled, the points used for calculation of the registration will be added as an overlay to the input image and displayed.</li><br><li><b>Registration mode</b> (default = "Fast") "The registration mode can be "Accurate", "Fast" and "Mono". The registration mode "Mono" makes the program to perform only unidirectional registration, i.e. from source to target. The two registration modes "Accurate" and "Fast" involve performing bidirectional registration and affect the stopping criteria internally used by the program."  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Subsample factor</b> (default = "0") "The registration will be calculated using subsampled versions of the images but the results will be applied to the original ones. The image subsampling parameter can be chosen between 0 and 7, i.e. the image dimensions can be reduced by a factor of 2^0 = 1 to 2^7 = 128. This is very useful when registering large images."  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Initial deformation mode</b> (default = "Very Coarse") "Determines the level of detail of the initial deformation. In bUnwarpJ this is defined by the number of B-splines used to represent the deformations:<br><br><table style="font:sans-serif;font-size:12"><tr><th>Deformation</th><th>Num. intervals in grid</th></tr><tr><td>Very coarse</td><td>1x1</td></tr><tr><td>Coarse</td><td>2x2</td></tr><tr><td>Fine</td><td>3x3</td></tr><tr><td>Very fine</td><td>8x8</td></tr><tr><td>Super fine</td><td>16x16</td></tr></table><font face="sans-serif" size="3"><br>If images start very far away from the right alignment, it is usually a good idea to go from "Very Coarse" to "Very Fine". If they start close to the right alignment, using a very coarse initial deformation could cause the algorithm to fail. So, in that case, it would be enough to set initial deformation to "Fine" and final deformation to "Very Fine". Use "Super Fine" only when you need a very high level of accuracy, because it makes the algorithm quite slower depending on the image sizes.  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Final deformation mode</b> (default = "Fine") See description for "Initial deformation mode"</li><br><li><b>Divergence weight</b> (default = "0.0") Regularizes the deformation by penalizing the divergence of the deformation vector field.  If you see that your transformations get too rough, it is a good idea to use this parameter.  A value of 0.1 is usually good if there's no prior knowledge about the deformation shape.  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Curl weight</b> (default = "0.0") Regularizes the deformation by penalizing the curl of the deformation vector field.  If you see that your transformations get too rough, it is a good idea to use this parameter.  A value of 0.1 is usually good if there's no prior knowledge about the deformation shape.  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Landmark weight</b> (default = "0.0") Forces the deformations to fit the landmark points.  Set it to 1.0 unless you're not using landmarks.  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Image weight</b> (default = "1.0") The weight to control the pixel values difference.  Leave it at 1.0 unless you want to do, for instance, landmark-only registration.  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Consistency weight</b> (default = "10.0") Forces the resulting deformations to be one (source to target) as close as possible to the inverse of the other one (target to source). Values between 10.0 and 30.0 usually work fine. It is only taken into account for registration modes "Fast" or "Accurate".  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br><li><b>Stop threshold</b> (default = "0.01") Stops the optimization process at each multiresolution level when the error relative change is not larger than this threshold.  Description taken from <a href="https://imagej.net/BUnwarpJ">https://imagej.net/BUnwarpJ</a></li><br></ul>

</div>
</body>